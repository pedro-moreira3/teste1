<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" template="/WEB-INF/template.xhtml" xmlns:pe="http://primefaces.org/ui/extensions">
    <ui:define name="content">
        <div class="ui-g ui-fluid">
			<div class="ui-g-12 ui-lg-12">
				<div class="card card-w-title">
                    <p:outputPanel id="pnPedido" styleClass="BordNone">

                        <h:inputHidden id="id" value="#{abastecimentoMB.entity.id}" />


                        <h1>Empréstimo Unitário</h1>
                        <div class="SeparatorFull"></div>


                        <p:panelGrid columns="2" columnClasses="ui-grid-col-2,ui-grid-col-10" layout="grid" styleClass="ui-panelgrid-blank" style="border:0px none; background-color:transparent;"
                            id="pnDados">

                            <p:outputLabel for="profissional" value="Profissional : " />
                            <p:autoComplete dropdown="true" queryDelay="1000" value="#{abastecimentoMB.profissional}" id="profissional" completeMethod="#{abastecimentoMB.geraSugestoes}"
                                var="profissional" itemLabel="#{profissional.dadosBasico.prefixoNome}" itemValue="#{profissional}" converter="profissional" forceSelection="true" required="true"
                                minQueryLength="3" styleClass="profissional" disabled="#{abastecimentoMB.entity.id != 0}">
                                <p:ajax event="itemSelect" listener="#{abastecimentoMB.handleSelectProfissional}" update=":lume:profissional,:lume:agendamento" />
                            </p:autoComplete>

                            <p:outputLabel for="prazo" value="Data Utilização : " />
                            <p:calendar id="prazo" value="#{abastecimentoMB.data}" required="true" pattern="dd/MM/yyyy" mask="true" showWeeksBar="false" locale="#{lumeSecurity.locale}"
                                timeZone="#{lumeSecurity.timeZone}" navigator="true" yearRange="-0:+1"
                                 disabled="#{abastecimentoMB.entity.id != 0}">
                                <p:ajax event="dateSelect" listener="#{abastecimentoMB.handleSelectData}" update=":lume:profissional,:lume:agendamento" />
                            </p:calendar>

                            <p:outputLabel for="agendamento" value="Agendamento : " />
                            <p:selectOneMenu id="agendamento" converter="agendamento" value="#{abastecimentoMB.entity.agendamento}">
                                <f:selectItem itemValue="#{null}" itemLabel="Selecione uma opção" />
                                <f:selectItems value="#{abastecimentoMB.agendamentos}" var="a" itemLabel="#{a.dataPaciente}" itemValue="#{a}" />
                                <p:ajax update=":lume:agendamentoProcedimentos" process=":lume:agendamento" listener="#{abastecimentoMB.carregaProcedimentos}" />
                            </p:selectOneMenu>

                            <p:outputLabel for="agendamentoProcedimentos" value="Procedimentos : " />
                            <p:selectCheckboxMenu id="agendamentoProcedimentos" converter="agendamentoPlano" value="#{abastecimentoMB.planoTratamentoProcedimentoAgendamentos}"
                                label="Selecione o(s) procedimento(s)">
                                <f:selectItems value="#{abastecimentoMB.agendamentoProcedimentos}" var="ap" itemValue="#{ap}" itemLabel="#{ap.planoTratamentoProcedimento.procedimento.descricao}" />
                            </p:selectCheckboxMenu>

                            <p:outputLabel value="Item: " for="digitacao" />
                            <p:column>
                                <p:autoComplete queryDelay="1000" id="digitacao" required="true" value="#{abastecimentoMB.digitacao}" minQueryLength="3" completeMethod="#{abastecimentoMB.filtraItem}"
                                    styleClass="itembusca" disabled="#{abastecimentoMB.entity.id != 0}">
                                    <p:ajax event="itemSelect" listener="#{abastecimentoMB.handleSelect}" update=":lume:tbItemTree, :lume:quantidade2" />
                                </p:autoComplete>
								<br /><br />
                                <p:tree value="#{abastecimentoMB.root}" var="item" id="tbItemTree" selection="#{abastecimentoMB.selectedItem}" selectionMode="single"
                                    rendered="#{abastecimentoMB.entity.id == 0}">
                                    <p:ajax event="select" listener="#{abastecimentoMB.onNodeSelect}" update=":lume:digitacao, :lume:quantidade2,:lume:dtMateriaisDisponiveis" process="@this" />
                                    <p:ajax event="unselect" listener="#{abastecimentoMB.onNodeUnselect}" />
                                    <p:treeNode>
                                        <h:outputText value="#{item.descricao}" />
                                    </p:treeNode>
                                </p:tree>
                            </p:column>

                            <p:outputLabel for="quantidade" value="Quantidade: " />
                            <p:column>                             
                                <p:inputText id="quantidade" value="#{abastecimentoMB.quantidade}" maxlength="10" required="true" onkeypress="validaNumeros(event)" rendered="#{abastecimentoMB.entity.id == 0}"/>
                                <h:outputText value="#{abastecimentoMB.quantidade}" rendered="#{abastecimentoMB.entity.id != 0}">
                                    <f:convertNumber />
                                </h:outputText>
                                
                                <h:outputLabel id="quantidade2" value="#{abastecimentoMB.getUnidadeString(abastecimentoMB.item)}" styleClass="unidadeMedidaString" disabled="true" />
                            </p:column>
                        </p:panelGrid>
                        <div class="SeparatorFull"></div>
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                            <p:commandButton id="busca" icon="White fa fa-search" value="Busca Itens" disabled="#{abastecimentoMB.entity.id!=0}" actionListener="#{abastecimentoMB.actionFindMateriais}"
                                update=":lume:pnPedido, :lume:dtAbastecimento, :lume:dtMateriaisDisponiveis" process=":lume:pnPedido" styleClass="OrangeButton" />
                        </p:panelGrid>

                        <div class="EmptyBox20"></div>

                        <p:dataTable filterDelay="1500"  reflow="true" var="materiaisSelecionado" value="#{abastecimentoMB.materiaisDisponiveis}" paginator="true" rows="7" paginatorPosition="bottom"
                            id="dtMateriaisDisponiveis" emptyMessage="" selection="#{abastecimentoMB.materiaisSelecionado}" rowKey="#{materiaisSelecionado.id}">
                            <f:facet name="header">Materiais Disponíveis</f:facet>

                            <p:column selectionMode="multiple" style="width:16px;text-align:center" />

                            <p:ajax event="rowSelect" update=":lume:persist,:lume:dtMateriaisDisponiveis" listener="#{abastecimentoMB.actionVerificaSalvar}" />
                            <p:ajax event="rowSelectCheckbox" update=":lume:persist,:lume:dtMateriaisDisponiveis" listener="#{abastecimentoMB.actionVerificaSalvar}" />
                            <p:ajax event="rowUnselectCheckbox" update=":lume:persist,:lume:dtMateriaisDisponiveis" listener="#{abastecimentoMB.actionVerificaSalvar}" />
                            <p:ajax event="toggleSelect" update=":lume:persist,:lume:dtMateriaisDisponiveis" listener="#{abastecimentoMB.actionVerificaSalvar}" />

                            <p:column filterBy="#{materiaisSelecionado.item.descricaoLimpa}" sortBy="#{materiaisSelecionado.item.descricao}" filterMatchMode="contains" headerText="Descrição">
                                <h:outputText value="#{materiaisSelecionado.item.descricao}" title="#{materiaisSelecionado.id}" />
                            </p:column>
                            <p:column filterBy="#{materiaisSelecionado.quantidadeAtual}" sortBy="#{materiaisSelecionado.quantidadeAtual}" filterMatchMode="contains" headerText="Quantidade Atual">
                                <h:outputText value="#{materiaisSelecionado.quantidadeAtual}">
                                    <f:convertNumber />
                                </h:outputText>
                                <h:outputText value="#{abastecimentoMB.getUnidadeString(materiaisSelecionado.item)}" styleClass="unidadeMedidaString" />
                            </p:column>
                            <p:column filterBy="#{materiaisSelecionado.marca.nome}" sortBy="#{materiaisSelecionado.marca.nome}" filterMatchMode="contains" headerText="Marca">
                                <h:outputText value="#{materiaisSelecionado.marca.nome}" />
                            </p:column>
                            <p:column filterBy="#{materiaisSelecionado.lote}" sortBy="#{materiaisSelecionado.lote}" filterMatchMode="contains" headerText="Lote">
                                <h:outputText value="#{materiaisSelecionado.lote}" />
                            </p:column>
                            <p:column filterBy="#{materiaisSelecionado.dataValidadeStr}" sortBy="#{materiaisSelecionado.dataValidade}" filterMatchMode="contains" headerText="Validade">
                                <h:outputText value="#{materiaisSelecionado.dataValidadeStr}" />
                            </p:column>
                            <p:column filterBy="#{materiaisSelecionado.local.descricao}" sortBy="#{materiaisSelecionado.local.descricao}" filterMatchMode="contains" headerText="Localização">
                                <h:outputText value="#{materiaisSelecionado.local.descricao}" />
                            </p:column>
                        </p:dataTable>
                        <br />
                        <div class="SeparatorFull"></div>
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                            <p:commandButton id="persist" icon="White fa fa-save" value="Salvar" actionListener="#{abastecimentoMB.actionPersist}"
                                update=":lume:pnPedido,:lume:dtAbastecimento,:lume:pnDados, @this, :lume:dtMateriaisDisponiveis" process=":lume:pnPedido" styleClass="GreenButton"
                                disabled="#{!abastecimentoMB.enableSalvar}" />
                            <p:commandButton id="new" icon="White fa fa-file-o" value="Novo" actionListener="#{abastecimentoMB.actionNew}" update=":lume:pnPedido :lume:dtAbastecimento"
                                immediate="true" />
                        </p:panelGrid>
                        <div class="EmptyBox20"></div>
                    </p:outputPanel>

                        <p:dataTable filterDelay="1500"  reflow="true" emptyMessage="" id="dtAbastecimento" value="#{abastecimentoMB.abastecimentos}" var="abastecimento" rows="15" paginator="true"
                            selection="#{abastecimentoMB.entity}" selectionMode="single" rowKey="#{abastecimento}" paginatorPosition="bottom">
                            <p:ajax event="rowSelect" update=":lume:pnPedido, :lume:dtMateriaisDisponiveis, :lume:persist" listener="#{abastecimentoMB.carregaTelaGeral}" />
                            <f:facet name="header">Empréstimos Unitários</f:facet>
                            <p:column filterBy="#{abastecimento.profissional.dadosBasico.prefixoNome}" sortBy="#{abastecimento.profissional.dadosBasico.prefixoNome}" filterMatchMode="contains"
                                headerText="Profissional">
                                <h:outputText value="#{abastecimento.profissional.dadosBasico.prefixoNome}" title="#{abastecimento.id}" />
                            </p:column>
                            <p:column filterBy="#{abastecimento.material.item.descricaoLimpa}" sortBy="#{abastecimento.material.item.descricao}" filterMatchMode="contains" headerText="Descrição">
                                <h:outputText value="#{abastecimento.material.item.descricao}" />
                            </p:column>
                            <p:column filterBy="#{abastecimento.agendamento.paciente.dadosBasico.nomeStr}" sortBy="#{abastecimento.agendamento.paciente.dadosBasico.nome}" filterMatchMode="contains"
                                headerText="Paciente">
                                <h:outputText value="#{abastecimento.agendamento.paciente.dadosBasico.nome}" />
                            </p:column>
                            <p:column filterBy="#{abastecimento.material.lote}" sortBy="#{abastecimento.material.lote}" filterMatchMode="contains" headerText="Lote">
                                <h:outputText value="#{abastecimento.material.lote}" />
                            </p:column>
                            <p:column sortBy="#{abastecimento.quantidadeInt}" filterBy="#{abastecimento.quantidadeInt}" filterMatchMode="contains" headerText="Quantidade Disponibilizada">
                                <h:outputText value="#{abastecimento.quantidade}">
                                    <f:convertNumber pattern="#0.00" locale="pt_BR" />
                                </h:outputText>
                                <h:outputText value="#{abastecimentoMB.getUnidadeString(abastecimento.material.item)}" styleClass="unidadeMedidaString" />
                            </p:column>
                            <p:column filterBy="#{abastecimento.dataEntregaStr}" filterMatchMode="contains" headerText="Data da Entrega" sortBy="#{abastecimento.dataEntrega}">
                                <h:outputText value="#{abastecimento.dataEntregaStr}" />
                            </p:column>
                        </p:dataTable>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>