<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" template="/WEB-INF/template.xhtml" xmlns:pe="http://primefaces.org/ui/extensions">
    <ui:define name="content">
    	<style>
	    	.autoComplete .ui-autocomplete input {
				height: 100%;
			}
		</style>
        <div class="ui-g ui-fluid">
			<div class="ui-g-12 ui-lg-12">
				<div class="card card-w-title">
                    <h:inputHidden id="idMaterial" value="#{materialMB.entity.id}" />
                    <p:outputPanel id="pnMaterial" styleClass="BordNone">
                        <h1>Entrada de Materiais</h1>
                        <div class="SeparatorFull"></div>
                        <p:panelGrid columns="2" columnClasses="ui-grid-col-6,ui-grid-col-6" layout="grid" styleClass="ui-panelgrid-blank" style="border:0px none; background-color:transparent;">
                            <p:column rendered="#{materialMB.estoqueCompleto}">
                                <h:outputLabel value="Local : " />
                                <p:autoComplete queryDelay="1000" id="digitacaoLocal" minQueryLength="3" disabled="#{materialMB.entity.id != 0}" value="#{materialMB.digitacaoLocal}"
                                    completeMethod="#{materialMB.filtraLocal}">
                                    <p:ajax event="itemSelect" listener="#{materialMB.handleSelectLocal}" update=":lume:tbLocalTree" />
                                </p:autoComplete>
                                <br /><br />
                                <p:tree value="#{materialMB.rootLocal}" var="local" rendered="#{materialMB.entity.id == 0}" id="tbLocalTree" selection="#{materialMB.selectedLocal}"
                                    selectionMode="single">
                                    <p:ajax event="select" listener="#{materialMB.onNodeSelectLocal}" update=":lume:digitacaoLocal" process="@this" />
                                    <p:ajax event="unselect" listener="#{materialMB.onNodeUnselectLocal}" />
                                    <p:treeNode>
                                        <h:outputText value="#{local.descricao}" />
                                    </p:treeNode>
                                </p:tree>
                            </p:column>

                            <p:column>
                                <h:outputLabel value="Item: " />
                                <p:autoComplete queryDelay="1000" id="digitacao" value="#{materialMB.digitacao}" disabled="#{materialMB.entity.id != 0}" completeMethod="#{materialMB.filtraItem}"
                                    minQueryLength="3">
                                    <p:ajax event="itemSelect" listener="#{materialMB.handleSelect}" update=":lume:tbItemTree, :lume:quantidadeAtual2" />
                                </p:autoComplete>
                                <br /><br />
                                <p:tree value="#{materialMB.root}" var="item" rendered="#{materialMB.entity.id == 0}" id="tbItemTree" selection="#{materialMB.selectedItem}" selectionMode="single">
                                    <p:ajax event="select" listener="#{materialMB.onNodeSelect}" update=":lume:digitacao, :lume:quantidadeAtual2" process="@this" />
                                    <p:ajax event="unselect" listener="#{materialMB.onNodeUnselect}" />
                                    <p:treeNode>
                                        <h:outputText value="#{item.descricao}" />
                                    </p:treeNode>
                                </p:tree>
                            </p:column>
                        </p:panelGrid>
                        <br />
                        <p:fieldset legend="Entrada" id="pnEntrada">
                            <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid"
                            	columnClasses="ui-g-2, ui-g-4, ui-g-2, ui-g-4"
                                style="border:0px none; background-color:transparent;" id="pgEntrada">
                                <p:outputLabel for="quantidade" value="Quantidade de volumes: " />
                                <p:inputText id="quantidade" value="#{materialMB.entity.quantidade}" maxlength="10" onkeypress="validaNumeros(event)" required="true"
                                    rendered="#{materialMB.entity.id == 0}">
                                    <p:ajax update=":lume:pgEntrada" process=":lume:quantidadeUnidade,@this" listener="#{materialMB.valorTotal}" />
                                </p:inputText>
                                <h:outputText value="#{materialMB.entity.quantidade}" rendered="#{materialMB.entity.id != 0}">
                                    <f:convertNumber />
                                </h:outputText>

                                <p:outputLabel for="quantidadeUnidade" value="Quantidade dentro do volume: " />
                                <p:inputText id="quantidadeUnidade" value="#{materialMB.entity.tamanhoUnidade}" maxlength="10" onkeypress="validaNumeros(event)" required="true"
                                    rendered="#{materialMB.entity.id == 0}">
                                    <p:ajax update=":lume:pgEntrada" process=":lume:quantidade,@this" listener="#{materialMB.valorTotal}" />
                                </p:inputText>
                                <h:outputText value="#{materialMB.entity.tamanhoUnidade}" rendered="#{materialMB.entity.id != 0}">
                                    <f:convertNumber />
                                </h:outputText>

                                <p:outputLabel for="quantidadeAtual" value="Quantidade Atual: " />
                                <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                                    <h:outputText id="quantidadeAtual" value="#{materialMB.entity.quantidadeAtual}">
                                        <f:convertNumber />
                                    </h:outputText>
                                    <h:outputLabel id="quantidadeAtual2" value="#{materialMB.getUnidadeString(materialMB.item)}" styleClass="unidadeMedidaString" disabled="true" />
                                </p:panelGrid>

                                <p:column rendered="#{materialMB.estoqueCompleto}"></p:column>
                                <p:column rendered="#{materialMB.estoqueCompleto}"></p:column>

                                <p:outputLabel for="valor" value="Valor do volume:" rendered="#{materialMB.estoqueCompleto}" />
                                <p:inputNumber id="valor" value="#{materialMB.entity.valorUnidadeInformado}" required="true" maxlength="13" maxValue="9999999999.99" decimalSeparator="," symbol="R$ "
                                    thousandSeparator="." rendered="#{materialMB.estoqueCompleto and materialMB.entity.id == 0}">
                                    <p:ajax update=":lume:pgEntrada" process=":lume:pgEntrada" listener="#{materialMB.valorTotal}" />
                                </p:inputNumber>
                                <h:outputText value="#{materialMB.entity.valorUnidadeInformado}" rendered="#{materialMB.estoqueCompleto and materialMB.entity.id != 0}">
                                    <f:convertNumber currencySymbol="R$" type="currency" maxFractionDigits="5" locale="#{lumeSecurity.locale}" />
                                </h:outputText>

                                <p:outputLabel for="valorTotal" value="Valor Total: " rendered="#{materialMB.estoqueCompleto}" />
                                <h:outputText id="valorTotal" value="#{materialMB.valorTotal}" rendered="#{materialMB.estoqueCompleto}">
                                    <f:convertNumber currencySymbol="R$" type="currency" maxFractionDigits="5" locale="#{lumeSecurity.locale}" />
                                </h:outputText>

                                <p:outputLabel for="procedencia" value="Procedência" rendered="#{materialMB.estoqueCompleto}" />
                                <p:selectOneMenu id="procedencia" value="#{materialMB.procedencia}" converter="dominio" required="true" rendered="#{materialMB.estoqueCompleto}">
                                    <f:selectItem itemValue="#{null}" itemLabel="Selecione uma opção" />
                                    <f:selectItems value="#{materialMB.procedencias}" var="procedencia" itemLabel="#{procedencia.nome}" itemValue="#{procedencia}" />
                                </p:selectOneMenu>

                                <p:outputLabel for="fornecedor" value="Fornecedor: " rendered="#{materialMB.estoqueCompleto}" />
                                <p:selectOneMenu id="fornecedor" value="#{materialMB.entity.fornecedor}" converter="fornecedor" required="true" class="Wid50 Min-Width-100" filter="true"
                                    filterMatchMode="contains" rendered="#{materialMB.estoqueCompleto}">
                                    <f:selectItem itemValue="#{null}" itemLabel="Selecione um fornecedor" />
                                    <f:selectItems value="#{materialMB.fornecedores}" var="f" itemLabel="#{f.dadosBasico.nome}" itemValue="#{f}" />
                                </p:selectOneMenu>

                                <p:outputLabel for="validade" value="Data Validade: " rendered="#{materialMB.estoqueCompleto}" />
                                <p:calendar id="validade" value="#{materialMB.entity.validade}" pattern="dd/MM/yyyy" mindate="#{materialMB.dateHoje}" mask="true"
                                    rendered="#{materialMB.estoqueCompleto}" />

                                <p:outputLabel for="marca" value="Marca : " rendered="#{materialMB.estoqueCompleto}" />
                                <p:column rendered="#{materialMB.estoqueCompleto}">
                                    <h:panelGroup id="pnBtmarca" style="display: flex !important;" styleClass="autoComplete">
                                        <p:autoComplete queryDelay="1000" value="#{materialMB.entity.marca}" id="marca" minQueryLength="3" completeMethod="#{materialMB.geraSugestoes}" var="marca"
                                            itemLabel="#{marca.nome}" itemValue="#{marca}" converter="marca" forceSelection="true" required="true" dropdown="true" style="margin-right: 5px"
                                            scrollHeight="400">
                                            <p:ajax event="itemSelect" listener="#{materialMB.handleSelectMarca}" update=":lume:marca" />
                                        </p:autoComplete>
                                        <p:commandButton id="novaMarca" disabled="#{materialMB.entity.id != 0}" rendered="#{!materialMB.novaMarca}" icon="fa fa-plus White"
                                            update="lblNovaMarca, valueNovaMarca, :lume:pnBtmarca" immediate="true" actionListener="#{materialMB.novo}" style="width: 33px !important" />
                                        <p:commandButton id="cancelarNovoMarca" disabled="#{materialMB.entity.id != 0}" rendered="#{materialMB.novaMarca}" icon="fa fa-minus White"
                                            update="lblNovaMarca, valueNovaMarca, :lume:pnBtmarca" immediate="true" actionListener="#{materialMB.cancelaNovo}" style="width: 33px !important" />
                                    </h:panelGroup>
                                </p:column>

                                <p:outputLabel for="lote" value="Lote : " rendered="#{materialMB.estoqueCompleto}" />
                                <p:inputText id="lote" value="#{materialMB.entity.lote}" maxlength="100" rendered="#{materialMB.estoqueCompleto}" />

								<p:outputPanel id="lblNovaMarca">
									<p:outputLabel for="nomeMarca" value="Nome : " rendered="#{materialMB.novaMarca}" />
								</p:outputPanel>
								<p:outputPanel id="valueNovaMarca">
		                            <p:outputPanel style="display: flex !important;" rendered="#{materialMB.novaMarca}">
										<p:inputText id="nomeMarca" value="#{materialMB.nomeMarca}" disabled="#{materialMB.entity.id != 0}" maxlength="200" required="#{materialMB.novaMarca}" />
		                                <p:commandButton id="persistMarca" icon="White fa fa-save" process="lblNovaMarca, valueNovaMarca" update="lblNovaMarca, valueNovaMarca, :lume:marca"
		                                	disabled="#{materialMB.entity.id != 0}" actionListener="#{materialMB.actionPersistMarca}" style="width: 33px !important" />
									</p:outputPanel>
								</p:outputPanel>

                            </p:panelGrid>

                        </p:fieldset>

                        <p:fieldset legend="Movimentação" id="pnMovimentacao" rendered="#{!materialMB.estoqueCompleto and materialMB.entity.id != 0}" style="margin-top: 15px;">
                            <p:panelGrid columns="4" columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4" layout="grid" styleClass="ui-panelgrid-blank"
                                style="border:0px none; background-color:transparent;">
                                <p:outputLabel for="tipoMovimentacao" value="Movimentação de: " />
                                <p:selectOneRadio id="tipoMovimentacao" value="#{materialMB.tipoMovimentacao}" columns="2" required="true">
                                    <f:selectItem itemLabel="Entrada" itemValue="E" />
                                    <f:selectItem itemLabel="Saída" itemValue="S" />
                                </p:selectOneRadio>
                                <p:outputLabel for="quantidadeMovimentacao" value="Quantidade: " />
                                <p:column>
                                    <p:inputText id="quantidadeMovimentacao" value="#{materialMB.quantidadeMovimentacao}" maxlength="10" required="true" onkeypress="validaNumeros(event)"
                                        style="width:20%" />
                                    <h:outputLabel id="quantidadeMovimentacao2" value="#{materialMB.getUnidadeString(materialMB.item)}" styleClass="unidadeMedidaString" disabled="true" />
                                </p:column>
                            </p:panelGrid>
                        </p:fieldset>
                        <br />

                        <div class="SeparatorFull"></div>
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                            <p:commandButton id="persist" icon="White fa fa-save" value="Salvar" actionListener="#{materialMB.actionPersist}" update=":lume:pnMaterial,:lume:dtMaterial"
                                process=":lume:pnMaterial" styleClass="GreenButton" />
							<p:commandButton id="devolucao" icon="White fa fa-mail-forward" onclick="PF('dlg').show();" value="Devolver" rendered="#{materialMB.estoqueCompleto}"
								update=":lume:pnMaterial,:lume:dtMaterial,:lume:pnJustificativa" process="@this" disabled="#{materialMB.entity.id == 0}" styleClass="OrangeButton" />
                            <p:commandButton id="new" icon="White fa fa-file-o" value="Novo" actionListener="#{materialMB.actionNew}" update=":lume:pnMaterial,:lume:dtMaterial" immediate="true" />
                        </p:panelGrid>

                    </p:outputPanel>

                    <br />

                    <p:dataTable filterDelay="1500"  reflow="true" emptyMessage="" id="dtMaterial" value="#{materialMB.materiais}" var="material" rows="15" paginator="true" selection="#{materialMB.entity}"
                        selectionMode="single" rowKey="#{material}" paginatorPosition="bottom">
                        <p:ajax event="rowSelect" update=":lume:pnMaterial" listener="#{materialMB.carregaTela}" oncomplete="topPage();" />
                        <f:facet name="header">Materiais</f:facet>
                        <p:column filterBy="#{material.item.descricaoLimpa}" sortBy="#{material.item.descricao}" filterMatchMode="contains" width="20%" headerText="Descrição">
                            <h:outputText value="#{material.item.descricao}" title="#{material.id}" />
                        </p:column>
                        <p:column filterBy="#{material.local.descricao}" sortBy="#{material.local.descricao}" filterMatchMode="contains" width="8%" headerText="Local"
                            rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.local.descricao}" />
                        </p:column>
                        <p:column filterBy="#{material.quantidadeAtual}" sortBy="#{material.quantidadeAtual}" width="10%" filterMatchMode="contains" headerText="Quantidade Atual">
                            <h:outputText value="#{material.quantidadeAtual}">
                                <f:convertNumber />
                            </h:outputText>
                            <h:outputLabel value="#{materialMB.getUnidadeString(materialMB.item)}" styleClass="unidadeMedidaString" disabled="true" />
                        </p:column>
                        <p:column filterBy="#{material.valor}" sortBy="#{material.valor}" width="11%" style="text-align:right" filterMatchMode="contains" headerText="Valor da Unidade(R$)"
                            rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.valor}">
                                <f:convertNumber currencySymbol="R$" type="currency" maxFractionDigits="5" locale="#{lumeSecurity.locale}" />
                            </h:outputText>
                        </p:column>
                        <p:column filterBy="#{material.marca.nome}" sortBy="#{material.marca.nome}" filterMatchMode="contains" width="7%" headerText="Marca" rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.marca.nome}" />
                        </p:column>
                        <p:column filterBy="#{material.lote}" sortBy="#{material.lote}" filterMatchMode="contains" width="5%" headerText="Lote" rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.lote}" />
                        </p:column>
                        <p:column filterBy="#{material.validadeStr}" sortBy="#{material.validade}" filterMatchMode="contains" width="7%" headerText="Validade" rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.validadeStr}" />
                        </p:column>
                        <p:column filterBy="#{material.procedenciaString}" sortBy="#{material.procedenciaString}" width="8%" filterMatchMode="contains" headerText="Procedência"
                            rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.procedenciaString}" />
                        </p:column>
                        <p:column filterBy="#{material.fornecedor.dadosBasico.nome}" sortBy="#{material.fornecedor.dadosBasico.nome}" width="8%" filterMatchMode="contains" headerText="Fornecedor"
                            rendered="#{materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.fornecedor.dadosBasico.nome}" />
                        </p:column>
                        <p:column filterBy="#{material.dataCadastroStr}" sortBy="#{material.dataCadastroStrOrd}" width="9%" filterMatchMode="contains" headerText="Dt. Cadastro">
                            <h:outputText value="#{material.dataCadastroStr}" />
                        </p:column>
                        <p:column filterBy="#{material.dataMovimentacaoStr}" sortBy="#{material.dataMovimentacao}" width="9%" filterMatchMode="contains" headerText="Dt. Últ. Movimentação"
                            rendered="#{!materialMB.estoqueCompleto}">
                            <h:outputText value="#{material.dataMovimentacaoStr}" />
                        </p:column>
                        <p:column headerText="Log" width="5%">
                            <p:commandButton icon="White fa fa-search" oncomplete="PF('dlgMaterialLog').show();" update=":lume:dtMaterialLog" process="@this"
                                actionListener="#{materialMB.carregarMaterialLog(material)}" style="width:33px !important" />
                        </p:column>
                    </p:dataTable>
                    <p:dialog id="dlg" widgetVar="dlg" header="Devolver" responsive="true" modal="true" width="90%">
                        <p:panel id="pnJustificativa" styleClass="BordNone">
                            <p:panelGrid columns="2" columnClasses="ui-grid-col-4,ui-grid-col-8" layout="grid" styleClass="ui-panelgrid-blank" style="border:0px none; background-color:transparent;">

                                <p:outputLabel for="quantidadeDevolvida" value="Quantidade à ser devolvida: " />
                                <p:column>
                                    <p:inputMask id="quantidadeDevolvida" value="#{materialMB.quantidade}" maxlength="8" mask="9?99999" required="true" styleClass="Wid50">
                                    </p:inputMask>
                                    <h:outputLabel value="#{materialMB.getUnidadeString(materialMB.item)}" styleClass="unidadeMedidaString" disabled="true" />
                                </p:column>

                                <p:outputLabel for="justificativa" value="Justificativa : " />
                                <p:selectOneMenu id="justificativa" required="true" value="#{materialMB.justificativa}" converter="dominio">
                                    <f:selectItem itemValue="#{null}" itemLabel="Selecione uma justificativa" />
                                    <f:selectItems value="#{materialMB.justificativas}" var="justificativa" itemLabel="#{justificativa.nome}" itemValue="#{justificativa}" />
                                </p:selectOneMenu>
                            </p:panelGrid>

							<br />
                            <div class="SeparatorFull"></div>
                            <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                                <p:commandButton id="persistDevolver" icon="White fa fa-save" value="Salvar" actionListener="#{materialMB.actionDevolver}"
                                    update=":lume:pnJustificativa,:lume:pnMaterial,:lume:dtMaterial" process="@this ,  :lume:pnJustificativa" oncomplete="handleDialogRequest(xhr, status, args)"
                                    styleClass="GreenButton" />
                            </p:panelGrid>
                            <div class="EmptyBox20"></div>
                        </p:panel>
                    </p:dialog>
                    <p:dialog id="dlgMaterialLog" widgetVar="dlgMaterialLog" header="Logs do Material" modal="true" width="90%">
                        <p:dataTable filterDelay="1500"  id="dtMaterialLog" reflow="true" emptyMessage="" value="#{materialMB.materialLogs}" var="m" rows="20" paginator="true" paginatorPosition="bottom">
                            <p:column filterBy="#{m.quantidadeAlterada}" sortBy="#{m.quantidadeAlterada}" filterMatchMode="contains" headerText="Qtd. Alterada">
                                <h:outputText value="#{m.quantidadeAlterada}" title="#{m.id}" />
                            </p:column>
                            <p:column filterBy="#{m.quantidadeAtual}" sortBy="#{m.quantidadeAtual}" filterMatchMode="contains" headerText="Qtd. Atual">
                                <h:outputText value="#{m.quantidadeAtual}" />
                            </p:column>
                            <p:column filterBy="#{m.acao}" sortBy="#{m.acao}" filterMatchMode="contains" headerText="Ação">
                                <h:outputText value="#{m.acao}" />
                            </p:column>
                            <p:column filterBy="#{m.profissional.dadosBasico.nome}" sortBy="#{m.profissional.dadosBasico.nome}" filterMatchMode="contains" headerText="Prof.">
                                <h:outputText value="#{m.profissional.dadosBasico.nome}" />
                            </p:column>
                            <p:column filterBy="#{m.dataStr}" sortBy="#{m.data}" filterMatchMode="contains" headerText="Data">
                                <h:outputText value="#{m.dataStr}" />
                            </p:column>
                        </p:dataTable>
                        <br />
                        <div class="SeparatorFull"></div>
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                            <p:commandButton id="fechar" icon="White fa fa-close" value="Fechar" process="@this" styleClass="RedButton" oncomplete="PF('dlgMaterialLog').hide()" />
                        </p:panelGrid>
                    </p:dialog>
                    <script type="text/javascript">
																					function handleDialogRequest(xhr, status, args) {
																						if (args.justificativa == true) {
																							PF('dlg').hide();
																						}

																					}
																				</script>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>