<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" template="/WEB-INF/template.xhtml" xmlns:pe="http://primefaces.org/ui/extensions">
    <ui:define name="content">
        <div class="ui-g ui-fluid">
			<div class="ui-g-12 ui-lg-12">
				<div class="card card-w-title">
                    <p:outputPanel styleClass="BordNone">
                        <h1>Devolução da Lavagem</h1>
                        <div class="SeparatorFull"></div>
                        <br />
                        
                        <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank ui-fluid form-group">
                        
                        	<h:panelGroup>
								<p:splitButton icon="White fa fa fa-file-excel-o"
									value="Exportar tabela para Excel"
									styleClass="GreenSplitButton"
									actionListener="#{lavagemMB.exportarTabelaDevolucao('xls')}"
									ajax="false" process="dtLavagensSolicitas,@this" update="@this"
									immediate="true"
									onclick="PrimeFaces.monitorDownload(function(){PF('loading').show();},function(){PF('loading').hide();});">

									<p:fileDownload
										value="#{lavagemMB.arquivoDownload}" />

									<p:menuitem value="Exportar tabela para PDF"
										icon="fa fa fa-file-pdf-o"
										actionListener="#{lavagemMB.exportarTabelaDevolucao('pdf')}"
										ajax="false" process="dtLavagensSolicitas,@this" immediate="true"
										onclick="PrimeFaces.monitorDownload(function(){PF('loading').show();},function(){PF('loading').hide();});">
										<p:fileDownload
											value="#{lavagemMB.arquivoDownload}" />
									</p:menuitem>
									<p:menuitem value="Exportar tabela para CSV"
										icon="fa fa fa-file-pdf-o"
										actionListener="#{lavagemMB.exportarTabelaDevolucao('csv')}"
										ajax="false" process="dtLavagensSolicitas,@this" immediate="true"
										onclick="PrimeFaces.monitorDownload(function(){PF('loading').show();},function(){PF('loading').hide();});">
										<p:fileDownload
											value="#{lavagemMB.arquivoDownload}" />
									</p:menuitem>
								</p:splitButton>
							</h:panelGroup>
                        
                        </p:panelGrid>
                        
                        <p:dataTable filterDelay="1500"  reflow="true" emptyMessage="" id="dtLavagensSolicitas" value="#{lavagemMB.lavagensSolicitadas}" var="lavagemSolicitada" rows="10" paginator="true"
                            selection="#{lavagemMB.lavagemSelecionadas}" rowKey="#{lavagemSolicitada}" paginatorPosition="bottom" widgetVar="tbLavagem" binding="#{lavagemMB.tabelaDevolucao}">
                            <f:facet name="header">Lavagens Solicitadas</f:facet>

                            <p:column selectionMode="multiple" style="width:16px;text-align:center" />
            

                            <p:ajax event="rowSelect" process="@this" update=":lume:dtKits, :lume:dtLavagensSolicitas, :lume:devolucao, :lume:actionEsterilizar,:lume:pnButton"
                                listener="#{lavagemMB.habilitaDevolucao}" />
                            <p:ajax event="rowSelectCheckbox" process="@this" update=":lume:dtKits, :lume:dtLavagensSolicitas, :lume:devolucao, :lume:actionEsterilizar,:lume:pnButton"
                                listener="#{lavagemMB.habilitaDevolucao}" />
                            <p:ajax event="rowUnselectCheckbox" process="@this" update=":lume:dtKits, :lume:dtLavagensSolicitas, :lume:devolucao, :lume:actionEsterilizar,:lume:pnButton"
                                listener="#{lavagemMB.habilitaDevolucao}" />
                            <p:ajax event="toggleSelect" process="@this" update=":lume:dtKits, :lume:dtLavagensSolicitas, :lume:devolucao, :lume:actionEsterilizar,:lume:pnButton"
                                listener="#{lavagemMB.habilitaDevolucao}" />



                            <p:column filterBy="#{lavagemSolicitada.descricao}" sortBy="#{lavagemSolicitada.descricao}" filterMatchMode="contains" headerText="Descrição"
                            		filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lavagemSolicitada.descricao}" title="#{lavagemSolicitada.id}" />
                            </p:column>
                            <p:column filterBy="#{lavagemSolicitada.observacao}" sortBy="#{lavagemSolicitada.observacao}" filterMatchMode="contains" headerText="Observação"
                            	filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lavagemSolicitada.observacao}" />
                            </p:column>

                            <p:column filterBy="#{lavagemSolicitada.solicitante.dadosBasico.prefixoNome}" sortBy="#{lavagemSolicitada.solicitante.dadosBasico.prefixoNome}" filterMatchMode="contains"
                                headerText="Solicitante" filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lavagemSolicitada.solicitante.dadosBasico.prefixoNome}" />
                            </p:column>
                            <p:column filterBy="#{lavagemSolicitada.profissional.dadosBasico.prefixoNome}" sortBy="#{lavagemSolicitada.profissional.dadosBasico.prefixoNome}" filterMatchMode="contains"
                                headerText="Esterilizador" filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lavagemSolicitada.profissional.dadosBasico.prefixoNome}" />
                            </p:column>
                            <p:column filterBy="#{lavagemSolicitada.status}" sortBy="#{lavagemSolicitada.status}" filterMatchMode="contains" headerText="Status">
                                <h:outputText value="#{lavagemSolicitada.status}" filterFunction="#{lavagemMB.filtroSemAcento}"/>
                            </p:column>

                            <p:column filterBy="#{lavagemSolicitada.dataValidadeStr}" sortBy="#{lavagemSolicitada.dataValidadeStr}" filterMatchMode="contains" headerText="Data de Validade">
                                <h:outputText value="#{lavagemSolicitada.dataValidadeStr}" />
                            </p:column>
                            <p:column filterBy="#{lavagemSolicitada.dataStr}" sortBy="#{lavagemSolicitada.dataStrOrd}" filterMatchMode="contains" headerText="Data do Pedido">
                                <h:outputText value="#{lavagemSolicitada.dataStr}" />
                            </p:column>
                            <p:column filterBy="#{lavagemSolicitada.resumo}" sortBy="#{lavagemSolicitada.resumo}" filterMatchMode="contains" headerText="Resumo">
                                <h:outputText value="#{lavagemSolicitada.resumo}" filterFunction="#{lavagemMB.filtroSemAcento}"/>
                            </p:column>

                            <p:column sortBy="#{lavagemSolicitada.clinica}" filterBy="#{lavagemSolicitada.clinica}" filterMatchMode="exact" headerText="Instrumento da clínica?">
                                <f:facet name="filter">
                                    <p:selectOneMenu onchange="PF('tbLavagem').filter()">
                                        <f:selectItem itemLabel="" itemValue="#{null}" noSelectionOption="true" />
                                        <f:selectItem itemLabel="Sim" itemValue="true" />
                                        <f:selectItem itemLabel="Não" itemValue="false" />
                                    </p:selectOneMenu>
                                </f:facet>
                                <h:outputText value="#{lavagemSolicitada.clinica == true ? 'Sim' : 'Não'}" />
                            </p:column>
                        </p:dataTable>

                        <br />

                        <p:dataTable filterDelay="1500"  reflow="true" emptyMessage="#{lavagemMB.msg}" id="dtKits" selection="#{lavagemMB.lavagemKitSelecionada}" selectionMode="single"
                            value="#{lavagemMB.lavagemKitsSolicitados}" var="lk" rowKey="#{lk}" rows="7" paginator="true" paginatorPosition="bottom">
                            <f:facet name="header">Detalhes</f:facet>
                            <p:ajax event="rowSelect" update=":lume:pnButton,:lume:pnDescartar" process=":lume:dtKits" listener="#{lavagemMB.actionLimpaJustificativa}" />
                            <p:column filterBy="#{lk.kit.descricao}" sortBy="#{lk.kit.descricao}" filterMatchMode="contains" headerText="Kit" filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lk.kit.descricao}" title="#{lk.id}" />
                            </p:column>
                            <p:column filterBy="#{lk.item.descricaoLimpa}" sortBy="#{lk.item.descricao}" filterMatchMode="contains" headerText="Item" filterFunction="#{lavagemMB.filtroSemAcento}">
                                <h:outputText value="#{lk.item.descricao}" />
                            </p:column>
                            <p:column filterBy="#{lk.quantidade}" sortBy="#{lk.quantidade}" filterMatchMode="contains" headerText="Quantidade">
                                <h:outputText value="#{lk.quantidade}" />
                            </p:column>
                        </p:dataTable>

                        <p:outputPanel id="pnButton" styleClass="BordNone">
                        	<br />
                            <div class="SeparatorFull"></div>
                            <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                                <p:commandButton id="actionEsterilizar" icon="White fa  fa-bitbucket" value="Esterilizar" actionListener="#{lavagemMB.actionEsterilizar}"
                                    disabled="#{!lavagemMB.enableDevolucao}" update=":lume:dtKits,:lume:dtLavagensSolicitas,:lume:pnButton" process=":lume:dtKits, @this" styleClass="GreenButton" />
                                <p:commandButton id="devolucao" icon="White fa fa-gavel" value="Finalizar" actionListener="#{lavagemMB.actionDevolucao}" disabled="#{!lavagemMB.enableDevolucao}"
                                    update=":lume:dtKits,:lume:dtLavagensSolicitas,:lume:pnButton" process=":lume:dtKits, @this" styleClass="OrangeButton" />
                                <p:commandButton id="actionDescartar" icon="White fa fa-trash" value="Descartar" onclick="PF('descartar').show()"
                                    update=":lume:dtKits, :lume:dtLavagensSolicitas,:lume:pnButton" process=":lume:dtKits, @this" styleClass="RedButton"
                                    disabled="#{lavagemMB.lavagemKitSelecionada == null || lavagemMB.lavagemKitSelecionada.lavagem.clinica == false}">
                                    <p:confirm header="Confirmação" message="Este item será retirado do estoque, deseja confirmar?" icon="ui-icon-alert" />
                                </p:commandButton>
                            </p:panelGrid>
                        </p:outputPanel>
                        
                        <p:dialog id="descartarTela" widgetVar="descartar" header="Descartar" responsive="true" modal="true">
                            <p:panel id="pnDescartar" style="display: inline-block;">
                                <p:panelGrid columns="2" columnClasses="ui-grid-col-4,ui-grid-col-8" layout="grid" styleClass="ui-panelgrid-blank"
                                    style="border:0px none; background-color:transparent;">

                                    <p:outputLabel for="quantidadeDescarte" value="Quantidade descartada : " />
                                    <p:inputText id="quantidadeDescarte" required="true" value="#{lavagemMB.quantidadeDescarte}">
                                        <f:validateLongRange minimum="1" />
                                    </p:inputText>

                                    <p:outputLabel for="justificativa" value="Justificativa : " />
                                    <p:selectOneMenu id="justificativa" required="true" value="#{lavagemMB.justificativa}" converter="dominio">
                                        <f:selectItem itemValue="#{null}" itemLabel="Selecione uma justificativa" />
                                        <f:selectItems value="#{lavagemMB.justificativas}" var="justificativa" itemLabel="#{justificativa.nome}" itemValue="#{justificativa}" />
                                    </p:selectOneMenu>

                                </p:panelGrid>
                                <p:separator class="SeparatorFull" />
                                <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank form-group ui-fluid">
                                    <p:commandButton id="persistDescartar" icon="White fa fa-save" value="Salvar" actionListener="#{lavagemMB.actionDescarte}"
                                        update=":lume:quantidadeDescarte, :lume:justificativa,:lume:dtKits, :lume:dtLavagensSolicitas,:lume:pnButton, :lume:pnDescartar"
                                        process=":lume:quantidadeDescarte, :lume:justificativa,:lume:dtKits, @this, :lume:pnDescartar" oncomplete="handleDialogRequest(xhr, status, args)"
                                        styleClass="GreenButton" />
                                </p:panelGrid>
                            </p:panel>
                        </p:dialog>
                        <script type="text/javascript">
																									function handleDialogRequest(xhr, status, args) {
																										if (args.descartar == true) {
																											PF('descartar').hide();
																										}

																									}
																								</script>
                    </p:outputPanel>
                </div>
            </div>
        </div>
    </ui:define>
</ui:composition>